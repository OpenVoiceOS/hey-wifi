!function(e,t){"function"==typeof define&&define.amd?define(["quiet-emscripten"],t):"object"==typeof module&&module.exports?module.exports=t(require("quiet-emscripten")):(e.Quiet=t(),e.quiet_emscripten_config=e.Quiet.emscriptenConfig)}(this,function(e){return function(){var e,t,i,n,r=16384,o=!1,c=!1,a="",u=[],s=[],l="",p="",m=[],f=[],d=Math.pow(2,14),v={},_=0;function g(){return o&&c}function q(){void 0===t&&(t=new(window.AudioContext||window.webkitAudioContext),console.log(t.sampleRate))}function h(){g()&&function(){for(var e=u.length,t=0;t<e;t++)u[t]()}()}function y(t){c||new Promise(function(e,i){var n=new XMLHttpRequest;n.overrideMimeType("application/json"),n.open("GET",t,!0),n.onload=function(){this.status>=200&&this.status<300?e(this.responseText):i(this.statusText)},n.onerror=function(){i(this.statusText)},n.send()}).then(function(t){e=t,c=!0,h()},function(e){!function(e){l=e;for(var t=s.length,i=0;i<t;i++)s[i](e)}("fetch of quiet-profiles.json failed: "+e)})}function b(e,t){if(g())e();else if(u.push(e),void 0!==t){if(""!==l)return void t(l);s.push(t)}}function w(){n=0,window.setTimeout(function(){i.call(navigator,void 0!==navigator.webkitGetUserMedia?{audio:{optional:[{googAutoGainControl:!1},{googAutoGainControl2:!1},{echoCancellation:!1},{googEchoCancellation:!1},{googEchoCancellation2:!1},{googDAEchoCancellation:!1},{googNoiseSuppression:!1},{googNoiseSuppression2:!1},{googHighpassFilter:!1},{googTypingNoiseDetection:!1},{googAudioMirroring:!1}]}}:void 0!==navigator.mozGetUserMedia?{audio:{echoCancellation:!1,mozAutoGainControl:!1,mozNoiseSuppression:!1}}:{audio:{echoCancellation:!1}},function(e){n=t.createMediaStreamSource(e),window.quiet_receiver_anti_gc=n,function(){for(var e=m.length,t=0;t<e;t++)m[t]()}()},function(e){!function(e){p=e;for(var t=f.length,i=0;i<t;i++)f[i](p)}(e.name)})},0)}return{emscriptenConfig:{onRuntimeInitialized:function(){o=!0,h()},locateFile:function(e){return"quiet-emscripten.js.mem"===e?a:e}},addReadyCallback:b,init:function(e){var t="quiet-profiles.json";void 0!==e.profilesPath?t=e.profilesPath:void 0!==e.profilesPrefix&&(t=e.profilesPrefix+"quiet-profiles.json"),y(t);var i="quiet-emscripten.js.mem";void 0!==e.memoryInitializerPath?i=e.memoryInitializerPath:void 0!==e.memoryInitializerPrefix&&(i=e.memoryInitializerPrefix+"quiet-emscripten.js.mem"),a=i,void 0!==e.emscriptenPath&&e.emscriptenPath,void 0!==e.onReady&&(void 0!==e.onError?b(e.onReady,e.onError):b(e.onReady));var n=document.getElementsByTagName("head")[0],r=document.createElement("script");r.type="text/javascript",r.src=e.emscriptenPath,n.appendChild(r)},transmitter:function(i){var n,o,c=i.profile;"object"==typeof c?(n=quiet_emscripten.intArrayFromString(JSON.stringify({profile:c})),o=quiet_emscripten.intArrayFromString("profile")):(n=quiet_emscripten.intArrayFromString(e),o=quiet_emscripten.intArrayFromString(c)),q();var a,u=i.onFinish,s=quiet_emscripten.ccall("quiet_encoder_profile_str","pointer",["array","array"],[n,o]),l=quiet_emscripten.ccall("quiet_encoder_create","pointer",["pointer","number"],[s,t.sampleRate]);quiet_emscripten.ccall("free",null,["pointer"],[s]),void 0===i.clampFrame&&(i.clampFrame=!0),a=i.clampFrame?quiet_emscripten.ccall("quiet_encoder_clamp_frame_len","number",["pointer","number"],[l,r]):quiet_emscripten.ccall("quiet_encoder_get_frame_len","number",["pointer"],[l]);var p,m,f=quiet_emscripten.ccall("malloc","pointer",["number"],[4*r]),d=quiet_emscripten.HEAPF32.subarray(f/4,f/4+r),v=!1,_=!1,g=function(e){var t=e.outputBuffer.getChannelData(0);if(!0!==y)y=!0,t.set(d),window.setTimeout(C,0);else for(var i=0;i<r;i++)t[i]=0},h=function(){_||(p.disconnect(),m.disconnect(),v=!1)},y=!0,b=[],w=(new Uint8Array(b),0),A=[],C=function(){if(!_){for(var e=!1,n=!1;;){var o=b.shift();if(void 0===o)break;if(e=!0,-1===(a=quiet_emscripten.ccall("quiet_encoder_send","number",["pointer","array","number"],[l,new Uint8Array(o),o.byteLength]))){b.unshift(o);break}n=!0}if(0===b.length&&!0===n&&void 0!==i.onEnqueue&&window.setTimeout(i.onEnqueue,0),!0===e&&!1===v&&function(){if(!_){if(void 0===m){var e=t.createScriptProcessor||t.createJavaScriptNode;(m=e.call(t,r,1,2)).onaudioprocess=g,(p=t.createOscillator()).type="square",p.frequency.value=420}p.connect(m),m.connect(t.destination),v=!0}}(),!1!==y){var c=new Date,a=quiet_emscripten.ccall("quiet_encoder_emit","number",["pointer","pointer","number"],[l,f,r]),s=new Date;if(A.unshift(s-c),A.length>3&&A.pop(),!1===e&&-1===a){if(w<3){for(var q=0;q<r;q++)d[q]=0;return w++,void(y=!1)}return void 0!==u&&u(),void(!0===v&&h())}if(y=!1,w=0,a<r)for(q=a;q<r;q++)d[q]=0}}};return{transmit:function(e){if(!_){for(var t=0;t<e.byteLength;){var i=e.slice(t,t+a);t+=i.byteLength,b.push(i)}C()}},destroy:function(){_||(quiet_emscripten.ccall("free",null,["pointer"],[f]),quiet_emscripten.ccall("quiet_encoder_destroy",null,["pointer"],[l]),!0===v&&h(),_=!0)},frameLength:a,getAverageEncodeTime:function(){if(0===A.length)return 0;for(var e=0,t=0;t<A.length;t++)e+=A[t];return e/A.length}}},receiver:function(o){var c,a,u=o.profile;"object"==typeof u?(c=quiet_emscripten.intArrayFromString(JSON.stringify({profile:u})),a=quiet_emscripten.intArrayFromString("profile")):(c=quiet_emscripten.intArrayFromString(e),a=quiet_emscripten.intArrayFromString(u));var s=quiet_emscripten.ccall("quiet_decoder_profile_str","pointer",["array","array"],[c,a]);if(q(),void 0===i&&(i=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia),void 0!==i){void 0===n&&w();var l=t.createScriptProcessor(16384,2,1),g=_;v[g]=l,_++;var h=quiet_emscripten.ccall("quiet_decoder_create","pointer",["pointer","number"],[s,t.sampleRate]);quiet_emscripten.ccall("free",null,["pointer"],[s]);var y=quiet_emscripten.ccall("malloc","pointer",["number"],[4*r]),b=quiet_emscripten.ccall("malloc","pointer",["number"],[d]);void 0!==o.onReceiverStatsUpdate&&quiet_emscripten.ccall("quiet_decoder_enable_stats",null,["pointer"],[h]);var A=!1,C=function(){if(!A)for(;;){var e=quiet_emscripten.ccall("quiet_decoder_recv","number",["pointer","pointer","number"],[h,b,d]);if(-1===e)break;var t=quiet_emscripten.HEAP8.slice(b,b+e);o.onReceive(t.buffer)}},S=0,F=[],P=function(){if(!A){var e=new Date;quiet_emscripten.ccall("quiet_decoder_consume","number",["pointer","pointer","number"],[h,y,r]);var t=new Date;F.unshift(t-e),F.length>3&&F.pop(),window.setTimeout(C,0);var i=quiet_emscripten.ccall("quiet_decoder_checksum_fails","number",["pointer"],[h]);if(void 0!==o.onReceiveFail&&i>S&&window.setTimeout(function(){o.onReceiveFail(i)},0),S=i,void 0!==o.onReceiverStatsUpdate){var n=quiet_emscripten.ccall("malloc","pointer",["number"],[4]),c=quiet_emscripten.ccall("quiet_decoder_consume_stats","pointer",["pointer","pointer"],[h,n]),a=quiet_emscripten.HEAPU32[n/4];quiet_emscripten.ccall("free",null,["pointer"],[n]);for(var u=[],s=0;s<a;s++){var l={},p=(c+20*s)/4,m=quiet_emscripten.HEAPU32[p],f=quiet_emscripten.HEAPU32[p+1];l.errorVectorMagnitude=quiet_emscripten.HEAPF32[p+2],l.receivedSignalStrengthIndicator=quiet_emscripten.HEAPF32[p+3],l.symbols=[];for(var d=0;d<f;d++){var v=(m+8*d)/4;l.symbols.push({real:quiet_emscripten.HEAPF32[v],imag:quiet_emscripten.HEAPF32[v+1]})}u.push(l)}o.onReceiverStatsUpdate(u)}}};l.onaudioprocess=function(e){if(!A){var t=e.inputBuffer.getChannelData(0);quiet_emscripten.HEAPF32.subarray(y/4,y/4+r).set(t),window.setTimeout(P,0)}},function(e,t){if(void 0!==t){if(""!==p)return void t(p);f.push(t)}n instanceof MediaStreamAudioSourceNode?e():m.push(e)}(function(){n.connect(l),void 0!==o.onCreate&&window.setTimeout(o.onCreate,0)},o.onCreateFail);var E=t.createGain();return E.value=0,l.connect(E),E.connect(t.destination),{destroy:function(){A||(E.disconnect(),l.disconnect(),quiet_emscripten.ccall("free",null,["pointer"],[y]),quiet_emscripten.ccall("free",null,["pointer"],[b]),quiet_emscripten.ccall("quiet_decoder_destroy",null,["pointer"],[h]),delete v[g],A=!0)},getAverageDecodeTime:function(){if(0===F.length)return 0;for(var e=0,t=0;t<F.length;t++)e+=F[t];return e/F.length}}}void 0!==o.onCreateFail&&o.onCreateFail("getUserMedia undefined (mic not supported by browser)")},str2ab:function(e){for(var t=unescape(encodeURIComponent(e)),i=new ArrayBuffer(t.length),n=new Uint8Array(i),r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return i},ab2str:function(e){return decodeURIComponent(escape(String.fromCharCode.apply(null,new Uint8Array(e))))},mergeab:function(e,t){var i=new Uint8Array(e.byteLength+t.byteLength);return i.set(new Uint8Array(e),0),i.set(new Uint8Array(t),e.byteLength),i.buffer},disconnect:function(){void 0!==n&&(n.disconnect(),n=void 0,delete window.quiet_receiver_anti_gc)}}}()});